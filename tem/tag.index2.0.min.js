(function(t){function e(t,e){if(window.spmReportData){var i=e?e:t;window.spmReportData[t]=i}}var i={base:"//api.bilibili.com/x/tag/",list:{tags:"archive/tags",add:"archive/add",del:"archive/del",subscribe:"subscribe/add",unsubscribe:"subscribe/cancel",like:"archive/like2",hate:"archive/hate2",report:"archive/report"}};var s={filterString:function(t){var e=/select|update|delete|truncate|join|union|exec|insert|drop|count|’|"|;|>|<|%/i;return e.test(t)?false:true},substitute:function(t,e){return t.replace(/\\?\{([^}]+)\}/g,function(t,i){if(t.charAt(0)=="\\")return t.slice(1);return e[i]!=undefined?e[i]:""})}};var a={l1:4,l2:3,l3:1,l4:1};var n={todo:function(t){UserStatus.isLogin()?t():biliQuickLogin(function(){location.reload()})},del:function(t,e){var i=this;this.todo(function(){if(i.isUp()){t();return}if(UserStatus.level()>=a.l1){t()}else{(new MessageBox).show(e,"升级到LV4就能删除标签啦~",1e3,"info")}})},add:function(t,e){var i=this;this.todo(function(){if(i.isUp()){t();return}if(UserStatus.level()>=a.l2){t()}else{(new MessageBox).show(e,"升级到LV3就能添加标签啦~",1e3,"info")}})},report:function(t,e){var i=this;this.todo(function(){if(i.isUp()){t();return}if(UserStatus.level()>=a.l3){t()}else{(new MessageBox).show(e,"升级到LV1就能举报啦~",1e3,"info")}})},topOrTread:function(t,e){var i=this;this.todo(function(){if(i.isUp()){t();return}if(UserStatus.level()>=a.l4){t()}else{(new MessageBox).show(e,"升级到LV1就能顶/踩啦~",1e3,"info")}})},isUp:function(){return parseInt(window.uid)===parseInt(window.mid)}};var o={tagList:[],isOpenInfo:false,msgTime:1500,currentIndex:0,isOver:false};var r={container:t(".s_tag"),domUl:t("<ul class='tag-area clearfix'></ul>"),domNothing:t("<div class='nothing'>快来成为第一个添加标签的人吧~</div>"),domBtnAdd:t("<a class='btn-add'><span class='one'></span><span class='two'></span></a>"),domIpt:t("<div class='ipt'><input type='text' placeholder='按回车键完成输入'><a class='btn-close'></a><div class='tips'>标签字数超出限制</div></div>"),domLink:t("<div class='btn-view-tag'>"+"<a class='btn-view-mod' href='#' target='_blank'>查看标签修改记录</a>"+"<span>|</span>"+"<a class='btn-view-user' href='#' target='_blank'>查看标签使用说明</a>"+"</div>"),state:{isInput:false,currentTag:null,isFirst:false},createTagList:function(){this.clearTagList();var e=o.tagList.length;for(var i=0;i<e;i++){var s=o.tagList[i];var a=t("<li class='tag' data-index='"+i+"' data-tagid='"+s.tag_id+"'><a href='//search.bilibili.com/all?keyword="+encodeURIComponent(s.tag_name)+"&from_source=video_tag' target='_blank'>"+s.tag_name+"</a></li>");if(i===0&&this.state.isFirst){a.hide().fadeIn()}a.prependTo(this.domUl)}this.domLink.show();this.domNothing.hide()},clearTagList:function(){this.domUl.find(".tag").remove();o.isOpenInfo=false},loadTagListData:function(){var e=this;t.ajax({url:i.base+i.list.tags,type:"GET",dataType:"jsonp",data:{aid:aid,jsonp:"jsonp"},xhrFields:{withCredentials:true},success:function(t){if(t.code===0){o.tagList=t.data||[];o.tagList.reverse();e.createTagList();e.state.isFirst=true;e.domLink.show();e.domNothing.hide()}if(t.code===16006){}}})},hasTag:function(t){for(var e=0;e<o.tagList.length;e++){if(o.tagList[e].tag_name===t){return false}}return true},addTag:function(){var e=this;var a=this.domIpt.find("input");var n=t.trim(a.val());if(n.length>20){return false}if(n&&s.filterString(n)){if(this.hasTag(n)){t.ajax({url:i.base+i.list.add,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{aid:aid,tag_name:n,jsonp:"jsonp"},success:function(t){if(t.code===0){e.switchInputState();o.tagList.unshift({tag_id:t.tid,tag_name:n,cover:"",content:"",likes:0,hates:0,is_atten:0,attribute:0,type:0,ctime:0,state:0,count:{view:0,use:0,atten:0}});e.createTagList();e.tagEventBind()}else{(new MessageBox).show(a,t.message,o.msgTime,"error")}}})}else{(new MessageBox).show(a,"该标签已存在",o.msgTime,"error")}}else{(new MessageBox).show(a,"输入内容为空或含非法字符",o.msgTime,"error")}},domRender:function(){this.container.find(".tag-list").remove();this.setLogUrl();this.domUl.prependTo(this.container);this.domLink.appendTo(this.container);this.domNothing.prependTo(this.domUl);this.domBtnAdd.appendTo(this.domUl);this.domIpt.appendTo(this.domUl);this.bindUI()},setLogUrl:function(){var e=t(".v-title h1").attr("title");this.domLink.find(".btn-view-mod").attr("href","//www.bilibili.com/taglog#aid="+aid+"&title="+encodeURI(e));this.domLink.find(".btn-view-user").attr("href","//www.bilibili.com/html/help.html#s")},bindUI:function(){var i=this;this.domBtnAdd.off("click").click(function(s){n.add(function(){if(!o.isOpenInfo)i.switchInputState()},t(this));s.stopPropagation();e("playpage_tag_build")});this.domIpt.find(".btn-close").off("click").click(function(){i.switchInputState()});this.domIpt.off("click,input").on("click","input",function(t){t.stopPropagation()}).on("input","input",function(e){if(t(this).val().length>20){i.domIpt.find(".tips").show()}else{i.domIpt.find(".tips").hide()}});t(document).off("keydown").on("keydown",function(t){if(t.keyCode===13&&i.state.isInput){i.addTag()}});t(document).off("click").on("click",function(t){if(i.state.isInput){i.switchInputState()}});this.tagEventBind()},tagEventBind:function(){var i=this;this.domUl.off("mouseenter").on("mouseenter",".tag",function(){if(o.isOpenInfo)return;o.isOver=true;t(this)[0].isOver=true;var e=t(this);setTimeout(function(){if(e[0].isOver){var t=e.attr("data-index");o.currentIndex=t;i.state.currentTag=e;o.tagList[t]["x"]=e.offset().left;o.tagList[t]["y"]=e.offset().top+e.height()+6;o.tagList[t]["index"]=t;l.show(o.tagList[t])}},300)});this.domUl.off("mouseleave").on("mouseleave",".tag",function(e){if(o.isOpenInfo)return;o.isOver=false;t(this)[0].isOver=false;setTimeout(function(){if(!o.isOver)l.remove()},300)});this.domUl.off("click.domul").on("click.domul",".tag",function(i){e("tag_click",t(this).data("tagid"))})},switchInputState:function(){var e=this;this.state.isInput=!this.state.isInput;if(this.state.isInput){this.domBtnAdd.hide();this.domIpt.css({display:"block"}).animate({opacity:1,width:158})}else{this.domIpt.find("input").val("");this.domIpt.animate({width:23},function(){t(this).css({display:"none"});e.domBtnAdd.fadeIn(100)});this.domIpt.find(".tips").hide()}},delTag:function(t){var e=this;this.domUl.find(".tag[data-index="+o.currentIndex+"]").fadeOut(500,function(){o.tagList.splice(o.currentIndex,1);o.isOpenInfo=false;e.state.isFirst=false;e.createTagList();e.tagEventBind();if(o.tagList.length>0){e.domLink.show();e.domNothing.hide()}else{e.domNothing.show();e.domLink.hide()}})},getCurrentTag:function(){return this.state.currentTag},init:function(){this.domRender();this.loadTagListData()}};var l={isRemove:false,panel:null,delPanel:null,reportPanel:null,state:{reportType:null},domBox:"<div data-index={index} class='tag-info-pane' style='left:{x}px;top:{y}px'>"+"<div class='tag-header clearfix'>"+"<div class='tag-title'><a href='//www.bilibili.com/tag/{tag_id}/?pagetype=videopage' target='_blank'>{tag_name}</a></div>"+"<a class='btn-sub btn-subscribe'>+ 关注</a>"+"<a class='btn-sub btn-unsubscribe'>已关注</a>"+"</div>"+"<div class='btn-right-box'>"+"<a class='btn-crown'><i></i>顶 <span>{likesd}</span></a>"+"<a class='btn-tread'><i></i>踩 <span>{hatesd}</span></a>"+"</div>"+"<div class='text'>{content}</div>"+"<div class='tag-footer clearfix'>"+"<div class='btn-left-box'>"+"<a class='btn-close'>删除</a>"+"<a class='btn-report'>举报</a>"+"</div>"+"</div>"+"</div>",domDelPopup:"<div class='tag-del-popup'><p>确定要删除该标签吗？</p><a class='btn-ok'>确定</a><a class='btn-no'>取消</a></div>",domReportPopup:"<div class='tag-report-popup'>"+"<h3>请输入举报理由</h3>"+"<ul><li data-type='内容不相关'><i></i>内容不相关</li><li data-type='敏感信息'><i></i>敏感信息</li><li data-type='恶意攻击'><i></i>恶意攻击</li><li data-type='剧透内容'><i></i>剧透内容</li></ul>"+"<a class='btn-ok'>确定</a><a class='btn-close'></a>"+"</div>",show:function(i){var a=this;this.remove();i.likesd=this.yw(i.likes);i.hatesd=this.yw(i.hates);if(i.likes===0)i.likesd="";if(i.hates===0)i.hatesd="";this.panel=t(s.substitute(this.domBox,i)).css({display:"none"});this.setState(i);this.bindUI();this.panel.appendTo("body").fadeIn();e("playpage_tag")},yw:function(t){if(t>=1e8){return parseFloat(t/1e8).toFixed(1)+"亿"}else if(t>=1e4){return parseFloat(t/1e4).toFixed(1)+"万"}else{return t}},setState:function(t){if(!this.panel.find(".text").text())this.panel.find(".text").remove();this.switchSubscribeState(t.is_atten);if(UserStatus.isLogin()){if(n.isUp())return;if(UserStatus.level()<a.l1||o.tagList[o.currentIndex]["attribute"]){this.panel.find(".btn-close").addClass("the-grey")}}if(UserStatus.isLogin()){if(n.isUp())return;if(UserStatus.level()<a.l4){this.panel.find(".btn-report").addClass("the-grey");this.panel.find(".btn-crown").addClass("the-grey");this.panel.find(".btn-tread").addClass("the-grey")}}},bindUI:function(){var s=this;this.panel.find(".btn-subscribe").off("click").on("click",function(){var a=this;var r=o.currentIndex;n.todo(function(){t.ajax({url:i.base+i.list.subscribe,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:o.tagList[o.currentIndex]["tag_id"],jsonp:"jsonp"},success:function(e){if(e.code===0){s.switchSubscribeState(true);o.tagList[r].is_atten=1}else{(new MessageBox).show(t(a),e.message,o.msgTime,"error")}}})});e("playpage_tag_follow")});this.panel.find(".btn-unsubscribe").off("click").on("click",function(){var a=this;var r=o.currentIndex;n.todo(function(){t.ajax({url:i.base+i.list.unsubscribe,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:o.tagList[o.currentIndex]["tag_id"],jsonp:"jsonp"},success:function(e){if(e.code===0){s.switchSubscribeState(false);o.tagList[r].is_atten=0}else{(new MessageBox).show(t(a),e.message,o.msgTime,"error")}}})});e("playpage_tag_unfollow")});this.panel.find(".btn-unsubscribe").off("mouseover,mouseout").on({mouseover:function(){t(this).text("取消关注")},mouseout:function(){t(this).text("已关注")}});this.panel.find(".btn-close").off("click").on("click",function(){var e=o.currentIndex;var i=t(this).offset().left-60;var a=t(this).offset().top-115;n.del(function(){s.showDelPopup(i,a)},t(this))});this.panel.off("mouseleave").on("mouseleave",function(t){if(!s.isRemove){s.remove();o.isOver=false}});this.panel.off("mouseenter").on("mouseenter",function(t){o.isOver=true});this.panel.find(".btn-report").off("click").on("click",function(){var e=r.getCurrentTag().offset().left;var i=r.getCurrentTag().offset().top+28;n.report(function(){s.showReportPopup(e,i)},t(this))});this.panel.find(".btn-crown").off("click").on("click",function(){var e=this;var a=o.currentIndex;var r=t(this).find("span");var l=Number(r.text());n.topOrTread(function(){t.ajax({url:i.base+i.list.like,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:o.tagList[o.currentIndex]["tag_id"],aid:aid,jsonp:"jsonp"},success:function(i){if(i.code===0){if(o.tagList[a].liked==1){o.tagList[a].likes=o.tagList[a].likes-1;o.tagList[a].liked=0}else{o.tagList[a].likes=o.tagList[a].likes+1;o.tagList[a].liked=1}o.tagList[a].likesd=s.yw(o.tagList[a].likes);r.text(o.tagList[a].likesd?o.tagList[a].likesd:"");d.show(t(e),1,o.tagList[a].liked);if(o.tagList[a].hated===1){o.tagList[a].hates=o.tagList[a].hates-1;o.tagList[a].hatesd=s.yw(o.tagList[a].hates)?s.yw(o.tagList[a].hates):"";t(s.panel.find(".btn-tread span")).text(o.tagList[a].hatesd);d.show(t(s.panel.find(".btn-tread")),1,false);o.tagList[a].hated=0}}else{(new MessageBox).show(t(e),i.message,o.msgTime,"error")}}})},t(this))});this.panel.find(".btn-tread").off("click").on("click",function(){var e=this;var a=o.currentIndex;var r=t(this).find("span");var l=Number(r.text());n.topOrTread(function(){t.ajax({url:i.base+i.list.hate,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:o.tagList[o.currentIndex]["tag_id"],aid:aid,jsonp:"jsonp"},success:function(i){if(i.code===0){if(o.tagList[a].hated==1){o.tagList[a].hates=o.tagList[a].hates-1;o.tagList[a].hated=0}else{o.tagList[a].hates=o.tagList[a].hates+1;o.tagList[a].hated=1}o.tagList[a].hatesd=s.yw(o.tagList[a].hates);r.text(o.tagList[a].hatesd?o.tagList[a].hatesd:"");d.show(t(e),1,o.tagList[a].hated);if(o.tagList[a].liked===1){o.tagList[a].likes=o.tagList[a].likes-1;o.tagList[a].likesd=s.yw(o.tagList[a].likes)?s.yw(o.tagList[a].likes):"";t(s.panel.find(".btn-crown span")).text(o.tagList[a].likesd);d.show(t(s.panel.find(".btn-crown")),1,false);o.tagList[a].liked=0}}else{(new MessageBox).show(t(e),i.message,o.msgTime,"error")}}})},t(this))})},switchSubscribeState:function(t){if(t){this.panel.find(".btn-subscribe").hide();this.panel.find(".btn-unsubscribe").show()}else{this.panel.find(".btn-subscribe").show();this.panel.find(".btn-unsubscribe").hide()}},showDelPopup:function(e,s){var a=this;this.delPanel=t(this.domDelPopup);this.delPanel.css({left:e,top:s});t("body").append(this.delPanel);o.isOpenInfo=true;this.delPanel.find(".btn-ok").off("click").on("click",function(){var e=this;t.ajax({url:i.base+i.list.del,type:"POST",dataType:"json",data:{aid:aid,tag_id:o.tagList[o.currentIndex]["tag_id"],jsonp:"jsonp"},xhrFields:{withCredentials:true},success:function(i){if(i.code===0){a.isRemove=false;a.delPanel.remove();a.remove();r.delTag()}else{(new MessageBox).show(t(e),i.message,o.msgTime,"error")}}})});this.delPanel.find(".btn-no").off("click").on("click",function(t){a.isRemove=false;a.delPanel.remove();o.isOpenInfo=false});this.isRemove=true},showReportPopup:function(e,s){var a=this;this.state.reportType=null;this.reportPanel=t(this.domReportPopup);this.reportPanel.css({left:e,top:s});t("body").append(this.reportPanel);o.isOpenInfo=true;this.reportPanel.find("li").off("click").on("click",function(){t(this).addClass("on").siblings("li").removeClass("on");a.state.reportType=t(this).attr("data-type")});var n;this.reportPanel.find(".btn-ok").off("click").on("click",function(){var e=this;if(a.state.reportType){t.ajax({url:i.base+i.list.report,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{aid:aid,tag_id:o.tagList[o.currentIndex]["tag_id"],reason:a.state.reportType,jsonp:"jsonp"},success:function(i){if(i.code===0){a.reportPanel.find(".btn-close").click();if(n){n.close()}(new MessageBox).show(r.getCurrentTag(),"已提交举报",o.msgTime,"info")}else{if(n){n.close()}(new MessageBox).show(t(e),i.message,o.msgTime,"error")}}})}else{n=new MessageBox;n.show(t(e),"请选择举报原因",o.msgTime,"info")}});this.reportPanel.find(".btn-close").off("click").on("click",function(){a.reportPanel.remove();o.isOpenInfo=false});this.remove()},remove:function(){if(this.panel){this.panel.animate({opacity:0},function(){t(this).remove()})}}};var d={show:function(e,i,s){var a=t("<div class='tag-praise'><div>");var n=this;var o=t(e).offset().left;var r=t(e).offset().top;var l=s?"+"+i:"-"+i;var d=s?"plus":"reduce";a.css({display:"block",left:o,top:r}).addClass(d).text(l).appendTo("body");a.animate({top:r-18},function(){a.fadeOut(function(){a.remove()})})}};t(function(){r.init()})})(jQuery);